---
title: phantomjså®ç°æœåŠ¡ç«¯å±å¹•æˆªå›¾
categories: ç¼–ç¨‹ç¬”è®°
tags: [JavaEE, å°ç¨‹åº, Linux]
date: 2017-09-18 16:09:57
---

![phantomjs](/images/develop/51/phantomjs.png)

## å‰è¨€

å‰é˜µå­é‡åˆ°ä¸€ä¸ªéœ€æ±‚ï¼Œå¾®ä¿¡å°ç¨‹åºçš„æŸä¸€ä¸ªç•Œé¢ï¼Œéœ€è¦å±å¹•æˆªå›¾ï¼Œç„¶ååˆ†äº«å‡ºå»ã€‚ä½†å°ç¨‹åºå®˜æ–¹æ²¡æœ‰å¼€æ”¾å¯ä»¥æˆªå–è¶…è¿‡å±å¹•çš„å®Œæ•´ç•Œé¢çš„ APIï¼Œä¹Ÿå°±æ˜¯åªèƒ½æˆªå–å½“å‰å±å¹•å¯ä»¥çœ‹åˆ°çš„å†…å®¹ã€‚è€Œæˆ‘ä»¬éœ€è¦æˆªé•¿å›¾ï¼Œæ‰€ä»¥ç°æœ‰çš„ API ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œåªèƒ½æœåŠ¡ç«¯æƒ³åŠæ³•ç”Ÿæˆå›¾ç‰‡ã€‚æˆ‘å¶ç„¶å‘ç°äº† phantomjsï¼Œå¯ä»¥ç”±æœåŠ¡ç«¯å»åšç±»ä¼¼çˆ¬è™«çš„æ“ä½œæ¥ä¿å­˜å›¾ç‰‡ã€‚

<!-- more -->

## æ€è·¯

æƒ³åˆ°ä¸€ç§ç¼–ç¨‹ç¬”è®°ï¼Œå°±æ˜¯åšä¸€ä¸ª H5 çš„é¡µé¢ï¼ŒæœåŠ¡ç«¯ç”¨ä¸€ä¸ªåŸºäº webkit å†…æ ¸çš„æ— ç•Œé¢æµè§ˆå™¨ phantomjsï¼Œå»è®¿é—® H5 é¡µé¢åœ°å€ï¼Œæ¸²æŸ“ï¼Œç”Ÿæˆå›¾ç‰‡ï¼Œå¹¶ä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šï¼Œä»è€Œå®ç°æˆªå›¾åŠŸèƒ½ã€‚

## phantomjs

[å®˜ç½‘ http://phantomjs.org/](http://phantomjs.org/)

phantomjs æ˜¯ ä¸€ä¸ªåŸºäº webkit å†…æ ¸çš„æ— å¤´æµè§ˆå™¨ï¼Œæ²¡æœ‰ UI ç•Œé¢ã€‚å®ƒå°±æ˜¯ä¸€ä¸ªæµè§ˆå™¨ï¼Œåªæ˜¯å†…éƒ¨çš„ç‚¹å‡»ã€ç¿»é¡µç­‰äººä¸ºç›¸å…³æ“ä½œéœ€è¦ç¨‹åºè®¾è®¡å®ç°ã€‚

æä¾›äº† javascript API æ¥å£ï¼Œå¯ä»¥é€šè¿‡ js ç›´æ¥ä¸ webkit å†…æ ¸äº¤äº’ï¼Œåœ¨æ­¤ä¹‹ä¸Šå¯ä»¥ç»“åˆ Java è¯­è¨€ç­‰ï¼Œé€šè¿‡ Java è°ƒç”¨ js ç­‰ç›¸å…³æ“ä½œï¼Œä»è€Œè§£å†³äº†ä»¥å‰ c/c++ æ‰èƒ½æ¯”è¾ƒå¥½çš„åŸºäº webkit å¼€å‘ä¼˜è´¨é‡‡é›†å™¨çš„é™åˆ¶ã€‚

æä¾›äº† windowsã€linuxã€mac ç­‰ä¸åŒ OS çš„å®‰è£…ä½¿ç”¨åŒ…ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥åœ¨ä¸åŒå¹³å°ä¸Šï¼ŒäºŒæ¬¡å¼€å‘é‡‡é›†é¡¹ç›®ï¼ˆçˆ¬è™«ï¼‰æˆ–æ˜¯è‡ªåŠ¨é¡¹ç›®æµ‹è¯•ç­‰å·¥ä½œã€‚

### å¸¸ç”¨å†…ç½®å¯¹è±¡

```js
// è·å¾—ç³»ç»Ÿæ“ä½œå¯¹è±¡ï¼ŒåŒ…æ‹¬å‘½ä»¤è¡Œå‚æ•°ã€phantomjsç³»ç»Ÿè®¾ç½®ç­‰ä¿¡æ¯
var system = require('system');

// è·å–æ“ä½œdomæˆ–webç½‘é¡µçš„å¯¹è±¡ï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰“å¼€ç½‘é¡µã€æ¥æ”¶ç½‘é¡µå†…å®¹ã€requestã€responseå‚æ•°ï¼Œå…¶ä¸ºæœ€æ ¸å¿ƒå¯¹è±¡ã€‚
var page = require('webpage');

// è·å–æ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ï¼Œé€šè¿‡å®ƒå¯ä»¥æ“ä½œæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶æ“ä½œï¼ŒåŒ…æ‹¬readã€writeã€moveã€copyã€deleteç­‰ã€‚
var fs = require('fs');   
```

### å¸¸ç”¨API

```js
// é€šè¿‡pageå¯¹è±¡é€šè¿‡urlé“¾æ¥æ‰“å¼€é¡µé¢ï¼ŒåŠ è½½å®Œæˆåå›è°ƒ
page.open(url, function (status) {}

// å½“page.openè°ƒç”¨æ—¶ï¼Œä¼šé¦–å…ˆæ‰§è¡Œè¯¥å‡½æ•°ï¼Œåœ¨æ­¤å¯ä»¥é¢„ç½®ä¸€äº›å‚æ•°æˆ–å‡½æ•°ï¼Œç”¨äºåè¾¹çš„å›è°ƒå‡½æ•°ä¸­
page.onLoadStarted = function() {}

// pageçš„æ‰€è¦åŠ è½½çš„èµ„æºåœ¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œå¤±è´¥å›è°ƒå¤„ç†
page.onResourceError = function(resourceError) {}

// pageçš„æ‰€è¦åŠ è½½çš„èµ„æºåœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œå¯ä»¥å›è°ƒè¯¥å‡½æ•°
page.onResourceRequested = function(requestData, networkRequest) {}

// pageçš„æ‰€è¦åŠ è½½çš„èµ„æºåœ¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œæ¯åŠ è½½ä¸€ä¸ªç›¸å…³èµ„æºï¼Œéƒ½ä¼šåœ¨æ­¤å…ˆåšå‡ºå“åº”ï¼Œå®ƒç›¸å½“äºhttpå¤´éƒ¨åˆ†ï¼Œæ ¸å¿ƒå›è°ƒå¯¹è±¡ä¸ºresponseï¼Œå¯ä»¥è·å–æœ¬æ¬¡è¯·æ±‚çš„cookiesã€userAgentç­‰
page.onResourceReceived = function(response) {}

// æ‰“å°ä¸€äº›è¾“å‡ºä¿¡æ¯åˆ°æ§åˆ¶å°
page.onConsoleMessage = function (msg) {}

// alertä¹Ÿæ˜¯æ— æ³•ç›´æ¥å¼¹å‡ºçš„ï¼Œä½†å¯ä»¥å›è°ƒalertçš„å†…å®¹
page.onAlert = function(msg) {}

// å½“page.openæ—¶ï¼Œhttpè¯·æ±‚ï¼ˆä¸åŒ…æ‹¬æ‰€å¼•èµ·çš„å…¶å®ƒçš„åŠ è½½èµ„æºï¼‰å‡ºç°äº†å¼‚å¸¸ï¼Œå¦‚404ã€no route to web siteç­‰ï¼Œéƒ½ä¼šåœ¨æ­¤å›è°ƒæ˜¾ç¤ºã€‚
page.onError = function(msg, trace) {}

// å½“page.openæ‰“å¼€çš„urlï¼Œæˆ–è€…æ˜¯åœ¨æ‰“å¼€è¿‡ç¨‹ä¸­è¿›è¡Œäº†è·³è½¬ï¼Œå¯ä»¥åœ¨è¿™ä¸ªå‡½æ•°ä¸­å›è°ƒã€‚
page.onUrlChanged = function(targetUrl) {}

// å½“page.opençš„ç›®æ ‡URLè¢«çœŸæ­£æ‰“å¼€åï¼Œä¼šåœ¨è°ƒç”¨opençš„å›è°ƒå‡½æ•°å‰è°ƒç”¨è¯¥å‡½æ•°ï¼Œåœ¨æ­¤å¯ä»¥è¿›è¡Œå†…éƒ¨çš„ç¿»é¡µç­‰æ“ä½œ
page.onLoadFinished = function(status) {}

// åœ¨æ‰€åŠ è½½çš„web pageå†…éƒ¨æ‰§è¡Œè¯¥å‡½æ•°ï¼Œåƒç¿»é¡µã€ç‚¹å‡»ã€æ»‘åŠ¨ç­‰ï¼Œå‡å¯åœ¨æ­¤ä¸­æ‰§è¡Œ
page.evaluate(function(){});

// å°†å½“å‰pageçš„ç°çŠ¶æ¸²æŸ“æˆå›¾ç‰‡ï¼Œè¾“å‡ºåˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­å»ã€‚
page.render("");
```

## å®ç°

### ä¸‹è½½ phantomjs

å¯ä»¥ç›´æ¥å»[å®˜ç½‘](http://phantomjs.org/download.html), æ‰¾åˆ°å¯¹åº”æœåŠ¡å™¨æ“ä½œç³»ç»Ÿçš„å‹ç¼©åŒ…ï¼Œç„¶åä¸‹è½½ã€‚

```vim
$ wget https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2
```

ä½†æˆ‘åœ¨é¡ºä¸°çš„æœåŠ¡å™¨é‡Œä¸‹è½½ phantomjs å®˜ç½‘æä¾›çš„å‹ç¼©åŒ…ï¼Œä¸‹è½½é€Ÿåº¦è¿ 1KB/s éƒ½æ²¡æœ‰ã€‚
æˆ–è€…ä¹Ÿä¸‹è½½æºç ï¼Œè¿›è¡Œç¼–è¯‘ï¼ˆç¼–è¯‘çœŸçš„è¶…çº§æ…¢ï¼‰ã€‚äºæ˜¯æˆ‘åªèƒ½å…ˆä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ CDN åŠ é€Ÿçš„å­˜å‚¨ç©ºé—´ã€‚

**ä¸‹è½½ & è§£å‹**

```vim
$ wget https://cdn.bingo.ren/phantomjs-2.1.1-linux-x86_64.tar.bz2
$ tar -jxvf phantomjs-2.1.1-linux-x86_64.tar.bz2
```

phantomjs çš„å¯æ‰§è¡Œè„šæœ¬åœ¨æ ¹ç›®å½•ä¸‹çš„ bin ç›®å½•ä¸‹ï¼Œæµ‹è¯•ä¸€ä¸‹æ˜¯å¦å¯ç”¨

```vim
$ phantomjs-2.1.1-linux-x86_64/bin/phantomjs -v
-->2.1.1
```

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ª js è„šæœ¬ï¼Œæ¥å½“ phantomjs çš„å‚æ•°è¢«è°ƒç”¨ã€‚

### request.js

```js
var page = require('webpage').create();
var system = require('system');

var address = system.args[1];   // æˆªå›¾é¡µé¢åœ°å€
var output = system.args[2];    // ä¿å­˜å›¾ç‰‡å

page.viewportSize = { width: 414*2, height: 736*2 }; // é¡µé¢åˆå§‹é«˜åº¦

page.open(address, function (status) { // æ‰“å¼€é¡µé¢
        if (status === "success") { // åŠ è½½å®Œæˆ
                // é€šè¿‡åœ¨JSè·å–é¡µé¢çš„æ¸²æŸ“é«˜åº¦
                var rect = page.evaluate(function () {
                  return document.getElementsByTagName('html')[0].getBoundingClientRect();
                });
                // æŒ‰ç…§å®é™…é¡µé¢çš„é«˜åº¦ï¼Œè®¾å®šæ¸²æŸ“çš„å®½é«˜
                page.clipRect = {
                  top:    rect.top,
                  left:   rect.left,
                  width:  rect.width,
                  height: rect.height
                };
                // é¢„ç•™ä¸€å®šçš„æ¸²æŸ“æ—¶é—´
                window.setTimeout(function () {
                  page.render(output);
                  // var base64 = page.renderBase64('JPEG');
                  // console.log(base64);
                  page.close();
                  console.log('success');
                  phantom.exit();
                }, 1000);
        }
});
```

æ¸²æŸ“å›¾ç‰‡çš„ API æœ‰ä¸¤ä¸ªï¼š

- `page.render('IMG_NAME')` : æ¸²æŸ“å¹¶ä¿å­˜å›¾ç‰‡åˆ°æŒ‡å®šçš„è·¯å¾„
- `page.renderBase64('JPEG')` : æ¸²æŸ“å¹¶è½¬æ¢å›¾ç‰‡ä¸ºæŒ‡å®šæ ¼å¼çš„ Base64 ç¼–ç 

åˆ‡è®°ï¼Œä»£ç æœ€åä¸€å®šè¦åŠ å…¥ `phantom.exit()` æ–¹æ³•ç¡®ä¿ phantomjs é€€å‡ºã€‚

### æµ‹è¯•

```vim
$ /bin/phantomjs request.js https://www.baidu.com images/baidu.png
```

çœ‹åˆ°ç»ˆç«¯æ§åˆ¶å°è¾“å‡ºäº†`success`ï¼Œåˆ™ä¿å­˜å›¾ç‰‡æˆåŠŸï¼Œå®ç°äº† html é¡µé¢çš„æˆªå±ã€‚

## JavaEE è°ƒåº¦

å°ç¨‹åºè°ƒç”¨ JavaEE æ¥å£ï¼Œåº”ç”¨åœ¨æ¥å£çš„å®ç°ç±»ä¸­å»è°ƒ phantomJSï¼Œæ¸²æŸ“ç”Ÿæˆå›¾ç‰‡ï¼Œä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ï¼Œå¹¶æŠŠä¸ƒç‰›äº‘å›¾ç‰‡åœ°å€è¿”å›ç»™å‰ç«¯ï¼Œæœ€ç»ˆå®ç°æˆªå±ã€‚

### å£°æ˜å¸¸é‡

é¦–å…ˆå®šä¹‰å­—ç¬¦ä¸²å¸¸é‡ï¼ŒåŒ…æ‹¬è¦è®¿é—®å¹¶ä¿å­˜å›¾ç‰‡çš„ h5 é¡µé¢åœ°å€ï¼ŒphantomJS è„šæœ¬è·¯å¾„ï¼Œjs è·¯å¾„ï¼Œä¿å­˜å›¾ç‰‡çš„è·¯å¾„ç­‰ç­‰ï¼Œæ ¹æ®é¡¹ç›®çš„éœ€æ±‚å’ŒæœåŠ¡å™¨çš„é…ç½®è‡ªè¡Œä¿®æ”¹ã€‚

#### DKConstant.java

```java
/**
 * è›‹å£³åŸŸå
 */
private static final String DK_DOMIN = "https://api-wxc.sf-rush.com/";

/**
 * phantomJS é…ç½®
 */
private static final String DK_PHANTOMJS_PATH = "/data/wwwroot/sftc.dankal.cn/phantomjs/";

/**
 * phantomJS è„šæœ¬è·¯å¾„
 */
public static final String DK_PHANTOMJS_SHELLPATH = DK_PHANTOMJS_PATH + "bin/phantomjs";

/**
 * phantomJS jsè·¯å¾„
 */
public static final String DK_PHANTOMJS_JSPATH = DK_PHANTOMJS_PATH + "request.js";

/**
 * phantomJS æˆªå›¾ä¿å­˜è·¯å¾„
 */
public static final String DK_PHANTOMJS_OUTPUTPATH = DK_PHANTOMJS_PATH + "images/";

/**
 * phantomJS é¡µé¢åœ°å€
 */
public static final String DK_PHANTOMJS_WEB_URL = DK_DOMIN + "web/index.html?order_id=";

/**
 * phantomJS å›¾ç‰‡åœ°å€
 */
public static final String DK_PHANTOMJS_IMAGES = DK_DOMIN + "phantomjs/images/";
```

### å°è£…ç½‘é¡µæˆªå±å·¥å…·ç±»

ä¸»è¦ç”¨åˆ°äº† Runtime å»è°ƒç”¨ç³»ç»Ÿçš„

`Runtime.getRuntime()`å¯ä»¥å–å¾—å½“å‰ JVM çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œæ˜¯ Java ä¸­å”¯ä¸€ä¸€ä¸ªå¯ä»¥è·å–åˆ°è¿è¡Œæ—¶ç¯å¢ƒçš„æ–¹æ³•ã€‚Runtime å¯ä»¥ç”¨æ¥è°ƒç”¨å¤–éƒ¨å‘½ä»¤ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€ä¸ª bat æˆ– shell è„šæœ¬ï¼Œç„¶åç”¨ `exec(cmd)` æ¥è°ƒç”¨å®ƒã€‚

æˆ‘ä»¬å°±ç”¨å®ƒå»è°ƒç”¨ phantomJSã€‚

```java
/**
 * HTMLé¡µé¢æˆªå±å·¥å…·ç±»
 */
public class HtmlScreenShotUtil {

    /**
     * ç½‘é¡µæˆªå±ï¼Œå¹¶ä¿å­˜å›¾ç‰‡
     *
     * @param url    é¡µé¢åœ°å€
     * @param output ä¿å­˜å›¾ç‰‡å(ä¸å¸¦åç¼€)
     */
    public static String screenShot(String url, String output) {

        String outPutPath = DK_PHANTOMJS_OUTPUTPATH + output;

        Runtime rt = Runtime.getRuntime();
        StringBuilder sb = new StringBuilder();
        try {
            String cmd = DK_PHANTOMJS_SHELLPATH + " " + DK_PHANTOMJS_JSPATH + " " + url + " " + outPutPath;
            Process process = rt.exec(cmd);
            InputStream is = process.getInputStream();
            BufferedReader br = new BufferedReader(new InputStreamReader(is));
            String tmp = "";
            try {
                while ((tmp = br.readLine()) != null) {
                    sb.append(tmp);
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return sb.toString();
    }
}
```

### æ¥å£è°ƒç”¨

#### è¯·æ±‚

POST /order/share/screenShot

```json
{
	"order_id": 3631,
	"name": "BingoğŸ’¤"
}
```

#### æœåŠ¡ç«¯ä¸šåŠ¡é€»è¾‘

SpringMVC ç›¸å…³çš„ç•¥è¿‡ï¼Œä¸»è¦è´´ä¸€ä¸‹åœ¨ä¸šåŠ¡é€»è¾‘å±‚ä¸­å¯¹å·¥å…·ç±»çš„è°ƒç”¨ã€‚

```java
/**
 * è®¢å•åˆ†äº«å±å¹•æˆªå›¾
 */
public APIResponse screenShot(APIRequest request) {

    JSONObject requestObject = JSONObject.fromObject(request.getRequestParam());
    
    if (!requestObject.containsKey("order_id"))
        return APIUtil.paramErrorResponse("order_idä¸èƒ½ä¸ºç©º");

    String url = DK_PHANTOMJS_WEB_URL + requestObject.getInt("order_id");
    String imgName = System.currentTimeMillis() + ".jpg";
    
    // ä¿å­˜å›¾ç‰‡
    String result = HtmlScreenShotUtil.screenShot(url, imgName);
    //  imgName = DK_PHANTOMJS_IMAGES + imgName; // å¯ç›´æ¥è®¿é—®çš„è·¯å¾„

    JSONObject resultObject = new JSONObject();
    if (result.endsWith("success")) {
        // ä¸Šä¼ ä¸ƒç‰›äº‘ï¼Œè¿”å›ä¸ƒç‰›å›¾ç‰‡è·¯å¾„
        String imgSrc = qiniuService.uploadImageWithBase64(result.replace("success", ""));
        resultObject.put("img", imgSrc);
        return APIUtil.getResponse(SUCCESS, resultObject);
    } else {
        resultObject.put("error", result);
        return APIUtil.submitErrorResponse("ç”Ÿæˆå›¾ç‰‡å¤±è´¥", resultObject);
    }
}
```

æˆ‘è¿™é‡Œä½¿ç”¨çš„æ¸²æŸ“çš„æ–¹æ³•æ˜¯ `page.renderBase64('JPEG')` è€Œä¸æ˜¯ `page.render(output)`, åœ¨æ§åˆ¶å°ä¼šå…ˆè¾“å‡ºå›¾ç‰‡çš„ base64 ç¼–ç ï¼Œç„¶åå†è¾“å‡º `success`ï¼Œä¹Ÿå°±æ˜¯ä»¥`success`ç»“å°¾ã€‚

æ‰€ä»¥æˆ‘çš„å¤„ç†æ˜¯ï¼Œåˆ¤æ–­è¿”å›çš„ç»“æœæ˜¯ä¸æ˜¯ä»¥`success`ç»“å°¾ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¯´æ˜æ˜¯å›¾ç‰‡æ¸²æŸ“æˆåŠŸï¼ŒæŠŠç»“æœå­—ç¬¦ä¸²ä¸­çš„`success`æ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„å°±æ˜¯å›¾ç‰‡çš„ base64 ç¼–ç äº†ã€‚

æ¥ç€è°ƒç”¨è‡ªå·±å°è£…çš„ä¸ƒç‰›äº‘ä¸Šä¼ çš„æœåŠ¡ç±»çš„æ–¹æ³•ï¼Œå‚æ•°ä¸ºå›¾ç‰‡çš„ base64 ç¼–ç ï¼ŒæŠŠå›¾ç‰‡ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ï¼Œæœ€åæŠŠè¿”å›çš„ä¸ƒç‰›äº‘å›¾ç‰‡åœ°å€è¿”å›ç»™å‰ç«¯ï¼Œä¸€æ•´å¥—æ“ä½œå°±ç»“æŸäº†ã€‚

ä¸ºä»€ä¹ˆè¿™é‡Œä¸ç›´æ¥ç”¨ `imgName` å‘¢ï¼Ÿï¼ˆçœ‹æ³¨é‡Šæ‰çš„é‚£ä¸€è¡Œï¼Œç”±äºã€ŒæœåŠ¡å™¨ä¸Šä¿å­˜å›¾ç‰‡çš„åœ°å€ã€ä¸ã€Œé¡¹ç›®çš„æ ¹è·¯å¾„ã€æ˜¯åœ¨åŒçº§ç›®å½•ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡ç›¸åŒçš„åŸŸåè®¿é—®åˆ°ï¼ŒimgName å…¶å®æ˜¯ä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šçš„å›¾ç‰‡çš„ HTTP URLã€‚ï¼‰

åŸå› æœ‰ä¸¤ç‚¹ï¼š

- å› ä¸ºæœ‰ä¸Šä¼ ä¸ƒç‰›äº‘çš„éœ€æ±‚ï¼Œç›´æ¥é€šè¿‡ base64 ä¸Šä¼ å›¾ç‰‡æ›´å¿«ï¼Œæ›´ç®€å•ã€‚
- æˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œä¸€ç›´ä¿å­˜ä¸äº†å›¾ç‰‡ã€‚

è¿™ä¸¤ä¸ªç‚¹éƒ½æ˜¯å‘ï¼ŒçœŸçš„è¸©äº†å¾ˆä¹…ï¼Œè¸©å¾—å¾ˆæ·±ï¼Œéå¸¸æœ‰å¿…è¦è®°å½•ä¸‹æ¥ã€‚

#### æ¥å£å“åº”

```json
{
    "state": 200, 
    "message": "success", 
    "result": {
        "img": "https://sf.dankal.cn/share/15059086604928607cc30c67c.jpg"
    }
}
```

#### æ•ˆæœ

<!--![card.png](/images/develop/51/card.png)-->

<img src="/images/develop/51/card.png" width=414 height=736 />

## é—®é¢˜

### æ¸²æŸ“ Base64 çš„æ–¹å¼ï¼Œä¸Šä¼ å›¾ç‰‡å¤±è´¥

ä½¿ç”¨ `page.renderBase64('JPEG');` æ¸²æŸ“å¹¶è½¬æ¢å›¾ç‰‡ä¸ºæŒ‡å®šæ ¼å¼çš„ Base64 ç¼–ç ï¼Œphantomjs çš„è¿™ä¸ª API æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯æˆ‘é‡åˆ°äº†ä¸€ä¸ªæƒ…å†µï¼Œå°±æ˜¯å½“ request.js ä¸­çš„å®½é«˜è®¾å¾—å¾ˆå¤§æ—¶ï¼Œä¼šæœ‰é—®é¢˜ã€‚

```js
page.viewportSize = { width: 414*2, height: 736*2 };
```

ä¸ºäº†æ¸²æŸ“çš„å›¾ç‰‡çš„åˆ†è¾¨ç‡è¶³å¤Ÿé«˜ï¼Œä¿è¯å›¾ç‰‡è¶³å¤Ÿæ¸…æ™°ï¼Œæˆ‘ä¸€å¼€å§‹ç›´æ¥ç”¨ Retina å± iPhone 7 çš„æ¯”ä¾‹ã€Œ4.7è‹±å¯¸ï¼Œ414 x 746ï¼ˆ4å€ï¼‰ã€ï¼Œä¹Ÿå°±æ˜¯ `{width: 414*4, height: 736*4}`ã€‚

ç»“æœå‘ç°è·å–åˆ°çš„ base64 ç¼–ç éå¸¸é•¿ï¼Œè¶…è¿‡äº†å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦ 65355ã€‚é‚£ä¹ˆè·å–åˆ°çš„ base64 ç¼–ç åœ¨è½¬ä¸º Java å­—ç¬¦ä¸²çš„æ—¶å€™ä¼šæŠ›å¼‚å¸¸ï¼Œå°±ç®—ä¸æŠ›å¼‚å¸¸ï¼Œä¹Ÿæ˜¯ä¸å®Œæ•´çš„ã€‚ä¸Šä¼ è‚¯å®šä¼šå¤±è´¥çš„ï¼Œå°±ç®—ä¸Šä¼ æˆåŠŸï¼Œå›¾ç‰‡ä¹Ÿæ˜¯æ— æ³•æ˜¾ç¤ºæˆ–è€…æ˜¾ç¤ºä¸å®Œæ•´çš„ã€‚

#### è§£å†³

ç†è®ºä¸Šæ˜¯è§£å†³ä¸äº†çš„ï¼Œä½†ä¸ºä»€ä¹ˆæˆ‘è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨è¿™ç§æ–¹æ¡ˆå‘¢ï¼Ÿå› ä¸ºç»è¿‡è°ƒè¯•ï¼Œæˆ‘å‘ç°2å€çš„4.7è‹±å¯¸çš„åˆ†è¾¨ç‡ï¼Œåˆšåˆšåˆé€‚ï¼Œæ¸…æ™°åº¦è¿˜è¡Œï¼ŒBase64 ç¼–ç çš„é•¿åº¦ä¹Ÿåªæœ‰å‡ åƒã€‚

å› ä¸ºæˆ‘ä»¬çš„ç•Œé¢æ˜¯æœ‰å›ºå®šçš„æ¨¡æ¿çš„ï¼Œç”Ÿæˆçš„æ¯ä¸€å¼ å›¾ç‰‡å‡ ä¹éƒ½åªæœ‰æ–‡å­—å†…å®¹æ˜¯ä¸åŒçš„ï¼Œæ‰€å·®æ— å‡ ï¼Œå¾ˆç¨³å®šã€‚ Base64 ç¼–ç çš„é•¿åº¦ä¸ä¼šè¶…è¿‡ 65355ï¼Œæ‰€ä»¥å¯ä»¥è§„é¿è¿™ç§æ–¹æ¡ˆçš„ç¼ºé™·ã€‚

**æ„Ÿæ‚Ÿï¼šçœŸæ­£åˆé€‚çš„æ–¹æ¡ˆåº”è¯¥æ˜¯ç»è¿‡æ¯”è¾ƒã€è¯„ä¼°ã€æƒè¡¡è€Œå¾—å‡ºæ¥çš„ï¼Œè€Œä¸æ˜¯ç†è®ºä¸Šçš„ã€‚**

### ä¿å­˜å›¾ç‰‡çš„æ–¹å¼ï¼Œä¿å­˜ä¸äº†å›¾ç‰‡

é—®é¢˜æ˜¯è¿™æ ·çš„ï¼Œåœ¨å®Œæˆå„ç§å¸¸è§„æ“ä½œåï¼Œåœ¨æˆ‘æœ¬æœºçš„ macOS ä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰ã€‚
åŒæ ·çš„æ“ä½œï¼Œéƒ¨ç½²åˆ° centOS åï¼Œshell ç›´æ¥æ“ä½œ phantomjs æ²¡æœ‰é—®é¢˜ã€‚
å•ç‹¬å†™ä¸€ä¸ª Java æµ‹è¯•ç±»æ¥è°ƒç”¨ phantomjsï¼Œåœ¨ç»ˆç«¯ä¸­ç”¨ javac ç¼–è¯‘ java æ–‡ä»¶ï¼Œç„¶åå† java æ‰§è¡Œ class æ–‡ä»¶ï¼Œä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚
ä½†æ˜¯åœ¨ centOS éƒ¨ç½²äº† JavaEE åï¼Œå‰ç«¯è®¿é—®æ¥å£ï¼ŒæœåŠ¡ç«¯å†å»è°ƒç”¨ phantomjsï¼Œå°±å‡ºé—®é¢˜äº†ã€‚

é€šè¿‡ debugï¼Œå‘ç°ç¡®å®æœ‰è°ƒç”¨äº† phantomjsï¼Œåœ¨ phantomjs çš„ js ä¸­ console.log çš„è¾“å‡ºä¹Ÿå®Œå…¨æ­£å¸¸ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»çˆ¬åˆ°ç½‘é¡µæºä»£ç ï¼Œä¸€åˆ‡ä¼¼ä¹éƒ½å¾ˆæ­£å¸¸ï¼Œå”¯ç‹¬å›¾ç‰‡æ²¡æœ‰è¢«ä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šã€‚

tomcat æ²¡æœ‰æŒ‡å®šç”¨æˆ·å’Œæƒé™ï¼Œç›¸å…³çš„ç›®å½•æƒé™éƒ½æ˜¯ 755ã€‚

#### è§£å†³

åœ¨ä¸‡èƒ½çš„åˆ›è½¯ä¿±ä¹éƒ¨ä¸­ï¼Œæˆ‘æå‡ºäº†æˆ‘çš„é—®é¢˜ï¼Œä¸‡èƒ½çš„è¶…å“¥å°±æå‡ºäº†å»ºè®®ï¼š

> åŸºæœ¬æ˜¯æƒé™é—®é¢˜äº†
> psæŒ‡ä»¤çœ‹çœ‹çœŸæ­£çš„è¿è¡Œå¸å·æ˜¯ä»€ä¹ˆ
> ä¹Ÿè®¸åªæ˜¯ä½ ä»¥ä¸ºæ˜¯root

æˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯ï¼Œ`sudo ...` ä¹Ÿå°±æ˜¯åœ¨ cmd å‰åŠ  sudoã€‚

```java
rt.exec("sudo " + cmd);
```
ç„¶è€Œå¹¶æ²¡æœ‰ä½œç”¨ï¼Œå¥½å§ï¼Œè€å°èªæ˜è¿˜æ˜¯æ²¡ç”¨çš„ï¼Œè¿˜æ˜¯çœ‹ä¸€ä¸‹ ps å§ã€‚å…ˆåœ¨æˆ‘çš„ macOS ä¸Šæ‰§è¡Œï¼š

```vim
$ ps -ef | grep tomcat
  501 91736 85028   0  5:25PM ??         0:51.52 /Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/bin/java -Djava.util.logging.config.file=/Users/bingo/Library/Caches/IntelliJIdea2017.1/tomcat/Unnamed_javaweb_ddj_2/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Dcom.sun.management.jmxremote= -Dcom.sun.management.jmxremote.port=1099 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Djava.rmi.server.hostname=127.0.0.1 -Djdk.tls.ephemeralDHKeySize=2048 -Djava.endorsed.dirs=/usr/local/apache-tomcat-8.0.36/endorsed -classpath /usr/local/apache-tomcat-8.0.36/bin/bootstrap.jar:/usr/local/apache-tomcat-8.0.36/bin/tomcat-juli.jar -Dcatalina.base=/Users/bingo/Library/Caches/IntelliJIdea2017.1/tomcat/Unnamed_javaweb_ddj_2 -Dcatalina.home=/usr/local/apache-tomcat-8.0.36 -Djava.io.tmpdir=/usr/local/apache-tomcat-8.0.36/temp org.apache.catalina.startup.Bootstrap start
  501 91868 91555   0  5:26PM ttys001    0:00.00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn tomcat
```

å¯ä»¥çœ‹åˆ°ç”¨æˆ·æ˜¯ 501ï¼Œå°±æ˜¯å½“å‰æˆ‘ç™»å½•çš„ç”¨æˆ·ï¼Œæƒé™æ²¡æœ‰é—®é¢˜ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹æœåŠ¡å™¨ä¸Šçš„ï¼š

```vim
$ ps -ef | grep tomcat
root       306 32747  0 17:26 pts/0    00:00:00 grep --color tomcat
www      32111     1  2 16:33 ?        00:01:08 /usr/java/jdk1.8.0_121/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.security.egd=file:/dev/./urandom -server -Xms256m -Xmx938m -Dfile.encoding=UTF-8 -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Djava.library.path=/usr/local/apr/lib -Djava.endorsed.dirs=/usr/local/tomcat/endorsed -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start
```

**www** ! å¥½å§ï¼Œçœ‹æ¥çœŸçš„æ˜¯æƒé™é—®é¢˜ã€‚ç»™ www ç”¨æˆ·åˆ†é…å›¾ç‰‡ä¿å­˜çš„ç›®å½•çš„å†™å…¥æƒé™å³å¯ã€‚

```vim
$ su www
$ chmod u+x /path/to/save/img
```

### è§£å†³ä¸­æ–‡ä¹±ç 

ç”¨ phantomjs å»æˆªå–ä¸­æ–‡é¡µé¢çš„ç½‘ç«™å¯èƒ½ä¼šå‡ºç°ä¹±ç çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æˆªå›¾ä¸­ä¸­æ–‡çš„ä½ç½®å…¨æ˜¯æ–¹æ¡†ã€‚

è§£å†³åŠæ³•ï¼š**å®‰è£…å­—ä½“**ã€‚

```vim
# centOS
$ yum install bitmap-fonts bitmap-fonts-cjk
# ubuntu
$ sudo apt-get install xfonts-wqy
```

### è§£å†³å­—ä½“å¤§å°ä¸ä¸€

æ‰§è¡Œä¸Šé¢å‘½ä»¤å®‰è£…å®Œåï¼Œå†å»æˆªå›¾ä¸­æ–‡çš„é¡µé¢å°±ä¸ä¼šå‡ºç°ä¸€å †çš„æ–¹æ¡†äº†ï¼Œä½†æ˜¯å­—ä½“å­˜åœ¨ç²—ç»†ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè€Œä¸”å­—ä½“å¾ˆä¸‘ï¼Œè·Ÿæˆ‘åœ¨ macOS ä¸‹çš„è‹¹æ–¹å­—ä½“å·®åˆ«å¤ªå¤§äº†ã€‚

è§£å†³åŠæ³•ï¼šå®‰è£…**å¾®è½¯é›…é»‘**å­—ä½“ï¼Œå»ºç«‹å­—ä½“ç´¢å¼•ï¼Œæ›´æ–°å­—ä½“ç¼“å­˜ã€‚

å¾®è½¯é›…é»‘å­—ä½“ `msyh.ttf` æœ‰ç‚¹éš¾æ‰¾ï¼Œå¯ä»¥ä» windows ä¸‹æ‹·è´è¿‡å»ï¼Œä¹Ÿå¯ä»¥åœ¨ç½‘ä¸Šä¸‹è½½ã€‚ç”±äºæˆ‘æ˜¯ macOSï¼Œåªèƒ½å»ç½‘ä¸Šæ‰¾äº†ï¼Œä¸ºäº†æ–¹ä¾¿ä»¥åç³»ç»Ÿè¿ç§»ä»¥åŠå¤šä¸ªç¯å¢ƒéœ€è¦å†æ¬¡ä¸‹è½½ï¼Œæˆ‘å·²ç»ä¼ åˆ° CDN ä¸ƒç‰›äº‘ä¸Šäº†ï¼Œä¸‹è½½åœ°å€ï¼š[https://cdn.bingo.ren/msyh.ttf](https://cdn.bingo.ren/msyh.ttf)

```vim
# centOS
$ yum -y install mkfontscale fontconfig
# unbuntu
$ apt-get -y install fontconfig xfonts-utils

$ mkdir /usr/share/fonts/win/
# ä¸‹è½½å¾®è½¯é›…é»‘å­—ä½“
$ wget https://cdn.bingo.ren/msyh.ttf -O /usr/share/fonts/win/msyh.ttf
# å»ºç«‹å­—ä½“ç´¢å¼•ï¼Œæ›´æ–°å­—ä½“ç¼“å­˜
$ cd /usr/share/fonts/win/
$ mkfontscale
$ mkfontdir
$ fc-cache
```

### è§£å†³ Emoji è¡¨æƒ…ä¹±ç 

å®‰è£…å®Œå¾®è½¯é›…é»‘å­—ä½“åï¼Œå†å»æˆªå›¾ï¼Œå‘ç°ä¸­æ–‡å­—ä½“çš„è¿˜åŸåº¦å¾ˆé«˜äº†ï¼Œå¤§å°ç²—ç»†ç­‰é—®é¢˜éƒ½æ²¡æœ‰äº†ã€‚ä½†æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ä¸­æ–‡ä¸­åŒ…å« Emoji è¡¨æƒ…ï¼Œä¹Ÿå°±æ˜¯ Unicode ç¼–ç çš„æ—¶å€™ï¼Œåˆä¹±ç äº†ï¼Œå…¨éƒ½æ˜¯æ–¹æ¡†ã€‚

è§£å†³åŠæ³•ï¼šå®‰è£…æ”¯æŒ Unicode ç¼–ç çš„å­—ä½“ã€‚

```vim
$ cd /usr/share/fonts/win/
$ wget https://cdn.bingo.ren/Segoe-UI-Symbol.ttf
```

ç„¶åå†æ¬¡å»ºç«‹å­—ä½“ç´¢å¼•ï¼Œæ›´æ–°å­—ä½“ç¼“å­˜

```vim
$ mkfontscale
$ mkfontdir
$ fc-cache
```

ç„¶è€Œï¼Œè™½ç„¶ä¸ä¼šå‡ºç°æ–¹æ¡†äº†ï¼Œä½†æ˜¯é»‘ç™½çš„ã€‚æš‚æ—¶è§£å†³ä¸äº†ï¼Œç¿»éäº†å­—ä½“éƒ½æ²¡æ‰¾åˆ°å½©è‰²çš„ emoji å­—ä½“ï¼Œä¹Ÿè®¸æ˜¯æˆ‘ç†è§£çš„æ¦‚å¿µä¸å¯¹ï¼Ÿemoji çš„æ˜¾ç¤ºä¼¼ä¹ä¸æ˜¯åº”è¯¥å­—ä½“æ”¯æŒï¼Œè€Œæ˜¯æµè§ˆå™¨æ”¯æŒï¼Œè€Œ phantomjs å´æ˜¯æ— ç•Œé¢çš„æµè§ˆå™¨ï¼Œæ‰€ä»¥æ— æ³•æ¸²æŸ“å‡ºç†æƒ³çš„ emoji è¡¨æƒ…ï¼Ÿä½†æ˜¯æˆ‘åœ¨ macOS ä¸‹æ˜¯å¯ä»¥æˆªæˆåŠŸçš„ï¼Œéš¾é“è¿˜è·Ÿç³»ç»Ÿçš„æ¶æ„æœ‰å…³ç³»ï¼Ÿæˆ‘å°è¯•æŠŠ macOS çš„å­—ä½“å…¨éƒ¨å¯¼å…¥ centOSï¼Œä¹Ÿæ— æ•ˆï¼Œå¾…æ·±å…¥ç ”ç©¶ï¼Œå†çœ‹èƒ½å¦è§£å†³ã€‚

## åè¯

æ²¡æƒ³åˆ°æœåŠ¡ç«¯ç”Ÿæˆå›¾ç‰‡ä¼šé‡åˆ°é‚£ä¹ˆå¤šçš„å‘ï¼Œè¿™é‡Œæˆ‘åªåˆ—ä¸¾äº†ä¸»è¦çš„æ³¨æ„ç‚¹ï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šç»†èŠ‚çš„é—®é¢˜ä¼šå¡ä½æ•´å¥—æµç¨‹ï¼Œæ¯”å¦‚ phantomjs æˆªå›¾å®½é«˜ä¸å¯¹ï¼Œéœ€è¦æŒ‰ç…§å®é™…é¡µé¢çš„é«˜åº¦ï¼Œè®¾å®šæ¸²æŸ“çš„å®½é«˜ï¼›åˆæ¯”å¦‚æ— æ³•æˆªé•¿å›¾ï¼Œéœ€è¦å‰ç«¯æ§åˆ¶ CSSï¼Œä¸èƒ½è®© `html` çš„ `height: 100%` ç­‰ç­‰ã€‚

å°½ç®¡é‡åˆ°äº†å¾ˆå¤šå‘ï¼Œåšäº†å¾ˆå¤šå°è¯•ï¼ŒèŠ±äº†æˆ‘å¾ˆå¤šæ—¶é—´å’Œç²¾åŠ›å»è§£å†³é—®é¢˜ï¼Œæœ€åè¿˜æœ‰é»‘ç™½ emoji çš„é—®é¢˜æ²¡æœ‰è§£å†³ã€‚ä½†æˆ‘ä¸€ç‚¹ä¹Ÿä¸æ„Ÿåˆ°æ„å¤–ï¼Œä¹Ÿä¸ä¼šåæ‚”ã€‚å› ä¸ºåœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘åœ¨ä¸æ–­å¼€é˜”æ€ç»´ï¼Œä¸æ–­æ‰©å……çŸ¥è¯†é¢ã€‚éšä¾¿å…¬å¸ç»™æˆ‘çš„æ—¶é—´ä¸å¤šï¼Œä½†æˆ‘ä»ç„¶ä¼šä¸ºäº†æœ€åä¸€ä¸ªé—®é¢˜ï¼Œå»ç ”ç©¶ emojiï¼Œç ”ç©¶ Unicode ç¼–ç ï¼Œä»¥åŠå®ƒåœ¨ä¸åŒå¹³å°çš„ä¸åŒæµè§ˆå™¨çš„æ˜¾ç¤ºå·®å¼‚åŠåŸç†ç­‰ã€‚

